# 無料給水スポット機能追加仕様書 v1.0

**追加日**: 2025年8月23日  
**機能名**: 川崎市無料給水スポット検索  
**データソース**: kawasaki_water_spots_v1.json

---

## 1. 機能概要

### 1.1 追加機能の目的
- 川崎市内の無料給水スポットを簡単に検索・確認できる機能
- 外出時の水分補給支援として保護者に有用な情報を提供
- 既存の給食情報と合わせて総合的な子育て支援アプリとしての価値向上

### 1.2 基本仕様
- **表示形式**: 地図表示とリスト表示の切り替え式
- **データ通信最適化**: 初回読み込み後はローカルキャッシュを活用
- **検索機能**: 区別フィルター、施設カテゴリ別フィルター
- **詳細表示**: 各スポットの詳細情報（住所、営業時間、設置場所）

---

## 2. UI/UX設計

### 2.1 ナビゲーション追加
既存のヘッダーナビゲーションに「給水スポット」タブを追加

```
[献立表示] [給水スポット] [学校選択]
```

### 2.2 給水スポット画面構成

#### 2.2.1 表示切り替えボタン
```
[🗺️ 地図表示] [📋 リスト表示]
```

#### 2.2.2 フィルター機能
- **区選択**: 全区 / 川崎区 / 中原区 / 高津区 / 宮前区 / 多摩区 / 麻生区
- **カテゴリ選択**: 全て / 区役所 / 図書館 / 市民館 / スポーツ施設 / その他

#### 2.2.3 地図表示モード
- 軽量な地図ライブラリ（Leaflet）を使用
- マーカーで給水スポット位置を表示
- マーカータップで基本情報ポップアップ表示
- ズーム機能、現在地表示機能

#### 2.2.4 リスト表示モード
- カード形式で給水スポット一覧表示
- 各カードに表示する情報：
  - 施設名
  - 区名・カテゴリ
  - 住所
  - 営業時間（簡易表示）
  - 現在地からの距離（位置情報許可時）

---

## 3. 技術実装仕様

### 3.1 データ構造最適化

#### 3.1.1 軽量化されたデータ形式
初回読み込み時のデータ量を削減するため、表示用とアプリ用でデータを分割

```javascript
// 初回読み込み用（軽量版）
const waterSpotsLight = {
  spots: [
    {
      id: "kawasaki_cityhall_south",
      name: "川崎市役所南庁舎",
      category: "市庁舎",
      ward: "川崎区",
      lat: 35.5297222222,
      lon: 139.7025,
      hours_summary: "平日 08:30-17:00"
    }
    // ...他のスポット（詳細情報は別途読み込み）
  ]
};
```

#### 3.1.2 詳細情報の遅延読み込み
詳細表示時のみフル情報を読み込み

```javascript
// 詳細情報取得API
GET /api/water-spots/detail?id=kawasaki_cityhall_south
```

### 3.2 ファイル構成追加
2025.08.24 完全版データを区ごとに分割する仕様に変更（全7ファイル）

```
src/
├── components/
│   └── water-spots/
│       ├── WaterSpotMap.js      # 地図表示コンポーネント
│       ├── WaterSpotList.js     # リスト表示コンポーネント
│       ├── WaterSpotCard.js     # スポットカードコンポーネント
│       ├── WaterSpotFilter.js   # フィルターコンポーネント
│       └── WaterSpotDetail.js   # 詳細モーダルコンポーネント
├── data/
│   ├── water-spots-light.json	 # 軽量版データ
│   ├── kawasaki_ku_water_spots.json # 完全版データ
│   ├── saiwai_ku_water_spots.json	 # 完全版データ
│   ├── nakahara_water_spots.jsonn	 # 完全版データ
│   ├── takatsu_ku_water_spots.json	 # 完全版データ
│   ├── miyamae_ku_water_spots.json	 # 完全版データ
│   ├── tama_ku_water_spots.json	 # 完全版データ
│   └── asao_ku_water_spots.json	 # 完全版データ
├── hooks/
│   └── useWaterSpots.js         # 給水スポット用フック
├── pages/
│   ├── api/
│   │   └── water-spots/
│   │       ├── list.js          # スポット一覧API
│   │       └── detail.js        # スポット詳細API
│   └── water-spots.js           # 給水スポットページ
└── utils/
    ├── geoUtils.js              # 位置情報計算ユーティリティ
    └── waterSpotUtils.js        # データ処理ユーティリティ
```

### 3.3 地図機能実装

#### 3.3.1 軽量地図ライブラリ選択
- **採用**: React-Leaflet（軽量、無料、オフライン対応可能）
- **理由**: Google Maps APIより軽量でコスト0円

#### 3.3.2 地図表示最適化
- 初期表示: 川崎市全体を表示
- マーカークラスタリング: 近接するスポットをグループ化
- 遅延読み込み: 表示範囲内のスポットのみマーカー表示
- マップはマーカーの視認性を考慮してOSMJFのものを使用する
- マーカーは標準マーカーを使用して色は青、現在地は赤とする

### 3.4 データキャッシュ戦略

#### 3.4.1 段階的データ読み込み
1. **初回読み込み**: 軽量版データ（約5KB）
2. **位置情報取得時**: 現在地周辺の詳細情報のみ
3. **詳細表示時**: 個別スポットの完全情報

#### 3.4.2 ローカルストレージ活用
```javascript
// キャッシュ機能
const CACHE_KEYS = {
  LIGHT_DATA: 'water_spots_light_v1',
  DETAIL_DATA: 'water_spots_detail_',
  USER_LOCATION: 'user_location',
  FILTER_SETTINGS: 'water_spots_filter'
};

// 有効期限: 7日間
const CACHE_EXPIRY = 7 * 24 * 60 * 60 * 1000;
```

---

## 4. パフォーマンス最適化

### 4.1 通信量最適化目標
- **初回読み込み**: 10KB以下
- **詳細表示**: 2KB以下/スポット
- **地図表示**: タイル読み込み最小化（ズームレベル制限）

### 4.2 表示パフォーマンス
- **仮想化**: リスト表示で50件以上の場合は仮想スクロール
- **遅延読み込み**: 地図マーカーの段階的表示
- **画像最適化**: アイコン画像のWebP/SVG使用

### 4.3 オフライン対応
- 一度読み込んだデータはローカル保存
- オフライン時は保存済みデータで表示継続
- ネットワーク復旧時に自動更新

---

## 5. API設計

### 5.1 給水スポット一覧API

**エンドポイント**: `/api/water-spots/list`

```javascript
// リクエスト例
GET /api/water-spots/list?ward=川崎区&category=区役所&light=true

// レスポンス例
{
  "success": true,
  "data": {
    "spots": [...],
    "total": 12,
    "updated": "2025-08-23"
  },
  "cache_ttl": 3600
}
```

### 5.2 スポット詳細API

**エンドポイント**: `/api/water-spots/detail`

```javascript
// リクエスト例
GET /api/water-spots/detail?id=kawasaki_cityhall_south

// レスポンス例
{
  "success": true,
  "data": {
    "id": "kawasaki_cityhall_south",
    "name": "川崎市役所南庁舎",
    "full_address": "川崎区東田町5-4",
    "install_location": "1階ホール",
    "hours": {
      "mon_fri": "08:30-17:00",
      "notes": "祝休日・12/29-1/3を除く"
    },
    "access_info": "川崎駅から徒歩8分",
    "sources": { ... }
  }
}
```

---

## 6. セキュリティ・プライバシー

### 6.1 位置情報取得
- **ユーザー同意**: 明示的な位置情報利用許可
- **データ保存**: 位置情報はローカルのみ、サーバー送信なし
- **精度調整**: 大まかな位置のみ使用（プライバシー保護）

### 6.2 API保護
既存のAPI保護機能を継承
- レート制限: 1分間に20リクエスト
- Referrerチェック
- 入力値検証

---

## 7. 開発・リリース計画

### 7.1 開発フェーズ（追加2週間）

#### Week 1: 基盤開発
- データ構造設計・API実装
- 基本UIコンポーネント作成
- 軽量地図機能実装

#### Week 2: 機能統合・テスト
- フィルター機能実装
- 既存アプリとの統合
- 動作テスト・パフォーマンス調整

### 7.2 追加投資
- **開発費**: 20万円（エンジニア工数）
- **運用費追加**: 月100円（地図タイル取得）
- **合計運用費**: 月300円（既存200円 + 追加100円）
- **初期はOSM公式タイル（無料）
- **アクセスが月数万件規模になったら MapTiler / Thunderforest に移行（月数百円〜千円台）

---

## 8. ユーザーストーリー

### 8.1 利用シーン例

#### シーン1: 公園遊び後の水分補給
「子どもと公園で遊んだ後、水筒が空になった。近くに給水できる場所はないかな？」
→ 現在地周辺の給水スポットを地図で確認、最短ルートで移動

#### シーン2: 外出先でのペットボトル節約
「買い物ついでに給水できる場所があれば、ペットボトルを買わずに済む」
→ 予定ルート上の給水スポットを事前確認

#### シーン3: 学校行事での事前確認
「運動会の準備で学校に行く前に、近くの給水場所を確認しておこう」
→ 学校周辺のスポットをリスト表示で確認

---

## 9. 成功指標

### 9.1 利用率目標
- **機能利用率**: 既存ユーザーの30%が月1回以上利用
- **新規ユーザー**: 給水スポット機能経由で月20人の新規登録
- **滞在時間**: 平均セッション時間10%向上

### 9.2 フィードバック収集
- アプリ内簡易アンケート機能
- 使いやすさ評価（5段階）
- 「役に立った」ボタン機能

---

## 10. 将来拡張計画

### 10.1 Phase 2機能（6ヶ月後）
- **水質情報**: 浄水器の有無、水質データ表示
- **混雑情報**: リアルタイム利用状況
- **ルート案内**: 給食と給水を組み合わせた外出プラン提案

### 10.2 他自治体展開対応
- データ構造の汎用化
- 自治体別設定ファイル化
- 横浜市・相模原市等への展開準備

---

この給水スポット機能追加により、「かわさき給食ナビ」は単なる献立確認アプリから、川崎市での子育て生活を総合的にサポートするプラットフォームに進化します。

低コスト（月100円追加）で高い付加価値を提供し、ユーザー満足度とアプリ利用頻度の向上が期待できます。